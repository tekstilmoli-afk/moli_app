<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Sipari≈ü Listesi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        th a { color: white; text-decoration: none; }
        th a:hover { text-decoration: underline; }
        .arrow { font-size: 0.8rem; }
        .filter-dropdown { max-height: 240px; overflow-y: auto; min-width: 180px; }
        .print-btn { padding: 2px 6px; font-size: 0.8rem; }
        .qr-img { width: 50px; height: 50px; object-fit: contain; }
        .stage-info { font-size: 0.7rem; line-height: 1.1; }
        .aciklama-cell { font-size: 0.75rem; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .table-responsive { overflow-x: auto; }
        thead th .dropdown-toggle { color: #fff; padding: 0; font-size: 0.85rem; }
        thead th .dropdown-toggle::after { margin-left: .35rem; }
        th, td { vertical-align: middle; white-space: nowrap; }
    </style>
</head>
<body class="bg-light py-4">

<div class="container-fluid">
    <h2 class="mb-4 text-center">üìã Sipari≈ü Listesi</h2>

    <!-- √úst bar -->
    <form method="get" class="mb-3">
        <div class="row g-2 align-items-stretch">
            <div class="col-12 col-md-2 d-grid">
                <a href="{% url 'order_create' %}" class="btn btn-primary">‚ûï Yeni Sipari≈ü</a>
            </div>
            <div class="col-12 col-md-4">
                <input type="text" name="q" value="{{ q }}" placeholder="Ara..." class="form-control">
            </div>
            <div class="col-12 col-md-2 d-grid">
                <button type="submit" class="btn btn-secondary">Ara</button>
            </div>
            <div class="col-12 col-md-2 d-grid">
                <a href="{% url 'export_orders_excel' %}?{{ request.GET.urlencode }}" class="btn btn-success">üì• Excel ƒ∞ndir</a>
            </div>
            <div class="col-12 col-md-2 d-grid">
                <a href="{% url 'order_list' %}" class="btn btn-outline-danger">‚ùå Filtreleri Kaldƒ±r</a>
            </div>
        </div>
    </form>

    {% if orders %}
    <div class="table-responsive">
        <form method="get" id="filterForm">
            <input type="hidden" name="q" value="{{ q }}">
            <table class="table table-bordered table-hover align-middle bg-white shadow-sm table-sm">
                <thead class="table-dark text-center align-middle">
                    <tr>
                        <!-- Sipari≈ü No -->
                        <th>
                            <div class="dropdown">
                                <a class="dropdown-toggle" href="#" data-bs-toggle="dropdown">No</a>
                                <div class="dropdown-menu p-2 filter-dropdown text-start">
                                    <small class="text-muted">Filtre yok</small>
                                </div>
                            </div>
                        </th>

                        <!-- Sipari≈ü Tipi -->
                        <th>
                            <div class="dropdown">
                                <a class="dropdown-toggle" href="#" data-bs-toggle="dropdown">Tip</a>
                                <div class="dropdown-menu p-2 filter-dropdown">
                                    {% for tip in tip_options %}
                                        {% if tip %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="siparis_tipi" value="{{ tip }}"
                                                   id="tip{{ forloop.counter }}" {% if tip in tip_selected %}checked{% endif %}>
                                            <label class="form-check-label" for="tip{{ forloop.counter }}">{{ tip }}</label>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                    <div class="d-grid mt-2">
                                        <button type="submit" class="btn btn-sm btn-primary">Filtrele</button>
                                    </div>
                                </div>
                            </div>
                        </th>

                        <!-- M√º≈üteri -->
                        <th>
                            <div class="dropdown">
                                <a class="dropdown-toggle" href="#" data-bs-toggle="dropdown">M√º≈üteri</a>
                                <div class="dropdown-menu p-2 filter-dropdown">
                                    {% for musteri in musteri_options %}
                                        {% if musteri %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="musteri" value="{{ musteri }}"
                                                   id="m{{ forloop.counter }}" {% if musteri in musteri_selected %}checked{% endif %}>
                                            <label class="form-check-label" for="m{{ forloop.counter }}">{{ musteri }}</label>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                    <div class="d-grid mt-2">
                                        <button type="submit" class="btn btn-sm btn-primary">Filtrele</button>
                                    </div>
                                </div>
                            </div>
                        </th>

                        <!-- √úr√ºn Kodu -->
                        <th>
                            <div class="dropdown">
                                <a class="dropdown-toggle" href="#" data-bs-toggle="dropdown">√úr√ºn</a>
                                <div class="dropdown-menu p-2 filter-dropdown">
                                    {% for urun in urun_options %}
                                        {% if urun %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="urun_kodu" value="{{ urun }}"
                                                   id="u{{ forloop.counter }}" {% if urun in urun_selected %}checked{% endif %}>
                                            <label class="form-check-label" for="u{{ forloop.counter }}">{{ urun }}</label>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                    <div class="d-grid mt-2">
                                        <button type="submit" class="btn btn-sm btn-primary">Filtrele</button>
                                    </div>
                                </div>
                            </div>
                        </th>

                        <!-- Renk -->
                        <th>
                            <div class="dropdown">
                                <a class="dropdown-toggle" href="#" data-bs-toggle="dropdown">Renk</a>
                                <div class="dropdown-menu p-2 filter-dropdown">
                                    {% for renk in renk_options %}
                                        {% if renk %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="renk" value="{{ renk }}"
                                                   id="r{{ forloop.counter }}" {% if renk in renk_selected %}checked{% endif %}>
                                            <label class="form-check-label" for="r{{ forloop.counter }}">{{ renk }}</label>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                    <div class="d-grid mt-2">
                                        <button type="submit" class="btn btn-sm btn-primary">Filtrele</button>
                                    </div>
                                </div>
                            </div>
                        </th>

                        <!-- Beden -->
                        <th>
                            <div class="dropdown">
                                <a class="dropdown-toggle" href="#" data-bs-toggle="dropdown">Beden</a>
                                <div class="dropdown-menu p-2 filter-dropdown">
                                    {% for beden in beden_options %}
                                        {% if beden %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="beden" value="{{ beden }}"
                                                   id="b{{ forloop.counter }}" {% if beden in beden_selected %}checked{% endif %}>
                                            <label class="form-check-label" for="b{{ forloop.counter }}">{{ beden }}</label>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                    <div class="d-grid mt-2">
                                        <button type="submit" class="btn btn-sm btn-primary">Filtrele</button>
                                    </div>
                                </div>
                            </div>
                        </th>

                        <th>Adet</th>
                        <th>Sipari≈ü</th>
                        <th>Teslim</th>
                        <th>A√ßƒ±klama</th>
                        <th>Kesim</th>
                        <th>Dikim</th>
                        <th>S√ºsleme</th>
                        <th>Hazƒ±r</th>
                        <th>Sevkiyat</th>
                        <th>Resim</th>
                        <th>QR</th>
                        <th>Yazdƒ±r</th>
                    </tr>
                </thead>

                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td><a href="{% url 'order_detail' order.pk %}" class="text-decoration-none">{{ order.siparis_numarasi }}</a></td>
                        <td>{{ order.siparis_tipi }}</td>
                        <td>{{ order.musteri }}</td>
                        <td>{{ order.urun_kodu }}</td>
                        <td>{{ order.renk }}</td>
                        <td>{{ order.beden }}</td>
                        <td>{{ order.adet }}</td>
                        <td>{{ order.siparis_tarihi|date:"d.m.Y" }}</td>
                        <td>{{ order.teslim_tarihi|date:"d.m.Y" }}</td>
                        <td class="aciklama-cell">{{ order.aciklama }}</td>

                        <td class="stage-info">{% if order.kesim_yapan %}<strong>{{ order.kesim_yapan }}</strong><br>{{ order.kesim_tarihi|date:"d.m.Y H:i" }}{% else %}-{% endif %}</td>
                        <td class="stage-info">{% if order.dikim_yapan %}<strong>{{ order.dikim_yapan }}</strong><br>{{ order.dikim_tarihi|date:"d.m.Y H:i" }}{% else %}-{% endif %}</td>
                        <td class="stage-info">{% if order.susleme_yapan %}<strong>{{ order.susleme_yapan }}</strong><br>{{ order.susleme_tarihi|date:"d.m.Y H:i" }}{% else %}-{% endif %}</td>
                        <td class="stage-info">{% if order.hazir_yapan %}<strong>{{ order.hazir_yapan }}</strong><br>{{ order.hazir_tarihi|date:"d.m.Y H:i" }}{% else %}-{% endif %}</td>
                        <td class="stage-info">{% if order.sevkiyat_yapan %}<strong>{{ order.sevkiyat_yapan }}</strong><br>{{ order.sevkiyat_tarihi|date:"d.m.Y H:i" }}{% else %}-{% endif %}</td>

                        <td>{% if order.resim %}<img src="{{ order.resim.url }}" alt="Resim" width="50">{% else %}-{% endif %}</td>
                        <td>{% if order.qr_code %}<img src="{{ order.qr_code.url }}" alt="QR Kod" class="qr-img">{% else %}-{% endif %}</td>

                        <td class="text-center">
                            <button type="button" class="btn btn-outline-secondary print-btn"
                                onclick="printLabel('{{ order.siparis_numarasi }}', '{{ order.musteri }}', '{{ order.urun_kodu }}', '{{ order.adet }}', '{% if order.qr_code %}{{ order.qr_code.url }}{% endif %}')">
                                üñ®Ô∏è
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="20" class="text-center text-muted">Hi√ß sipari≈ü yok.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
    </div>
    {% else %}
    <div class="alert alert-warning text-center">
        Hen√ºz sipari≈ü yok. Hemen yeni bir sipari≈ü ekleyebilirsiniz!
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
function printLabel(siparisNo, musteri, urunKodu, adet, qrUrl) {
    const printWindow = window.open('', '', 'width=350,height=400');
    printWindow.document.write(`
        <html>
        <head>
            <title>Etiket Yazdƒ±r</title>
            <style>
                body { font-family: Arial, sans-serif; text-align: center; padding: 10px; }
                .label-box { border: 1px solid #000; padding: 10px; margin: 10px auto; width: 280px; }
                .label-box img { max-width: 120px; margin-top: 10px; }
                .info { font-size: 14px; text-align: left; margin-top: 5px; }
                .info strong { display: inline-block; width: 100px; }
            </style>
        </head>
        <body>
            <div class="label-box">
                <h3>Sipari≈ü Etiketi</h3>
                <div class="info"><strong>No:</strong> ${siparisNo}</div>
                <div class="info"><strong>M√º≈üteri:</strong> ${musteri}</div>
                <div class="info"><strong>√úr√ºn:</strong> ${urunKodu}</div>
                <div class="info"><strong>Adet:</strong> ${adet}</div>
                ${qrUrl ? `<img src="${qrUrl}" alt="QR Kod">` : ''}
            </div>
            <script>window.onload = function(){ window.print(); setTimeout(()=>window.close(), 500); }<\/script>
        </body>
        </html>
    `);
    printWindow.document.close();
}
</script>

</body>
</html>

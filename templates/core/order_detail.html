{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Sipariş Detayı</title>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <style>
        .label { font-weight: 600; }
        .print-btn { float: right; }
        @media print { .no-print { display: none !important; } }
        .stage-buttons form {
            display: inline-block;
            margin-right: 5px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body class="bg-light py-5">

{% if user.is_authenticated %}
<div class="container mb-3 no-print">
    <div class="d-flex justify-content-end">
        <span class="me-2">👤 {{ user.username }}</span>
        <a href="{% url 'logout' %}" class="btn btn-sm btn-danger">Çıkış Yap</a>
    </div>
</div>
{% endif %}

<div class="container">
    <div class="card shadow-lg mx-auto p-4" style="max-width: 750px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="{% url 'order_list' %}" class="btn btn-outline-secondary btn-sm no-print">⬅ Geri</a>
            <h2 class="mb-0">📦 Sipariş Detayı</h2>

            <!-- ✅ Artık context'ten gelen is_manager kullanılıyor -->
            {% if is_manager %}
                <a href="{% url 'order_edit' order.id %}" class="btn btn-warning btn-sm">✏️ Düzenle</a>
            {% endif %}

            <button onclick="window.print()" class="btn btn-outline-primary no-print print-btn">🖨️ Yazdır</button>
        </div>

        <hr>

        <!-- 📝 Temel Bilgiler -->
        <div class="row mb-3">
            <div class="col-md-6"><span class="label">Sipariş No:</span> {{ order.siparis_numarasi }}</div>
            <div class="col-md-6"><span class="label">Sipariş Tipi:</span> {{ order.siparis_tipi }}</div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6"><span class="label">Müşteri:</span> {{ order.musteri }}</div>
            <div class="col-md-6"><span class="label">Ürün Kodu:</span> {{ order.urun_kodu }}</div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6"><span class="label">Renk:</span> {{ order.renk }}</div>
            <div class="col-md-6"><span class="label">Beden:</span> {{ order.beden }}</div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6"><span class="label">Adet:</span> {{ order.adet }}</div>
            <div class="col-md-6"><span class="label">Sipariş Tarihi:</span> {{ order.siparis_tarihi|date:"d.m.Y" }}</div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6"><span class="label">Teslim Tarihi:</span> {{ order.teslim_tarihi|date:"d.m.Y" }}</div>
            <div class="col-md-6"><span class="label">Açıklama:</span> {{ order.aciklama }}</div>
        </div>

        {% if order.resim or order.qr_code_url %}
        <div class="row mb-4 text-center align-items-center">
            <div class="col-md-6">
                <h6 class="fw-bold">📷 Ürün Resmi</h6>
                {% if order.resim %}
                    <img src="{{ order.resim.url }}" alt="Sipariş Resmi" class="img-fluid rounded shadow-sm" style="max-height: 200px;">
                {% else %}
                    <p class="text-muted">Henüz resim eklenmedi.</p>
                {% endif %}
            </div>

            <div class="col-md-6">
                <h6 class="fw-bold">📱 QR Kod</h6>
                {% if order.qr_code_url %}
                    <img src="{{ order.qr_code_url }}" alt="QR Kod" class="img-fluid rounded shadow-sm mb-2" style="max-height: 200px;">
                {% endif %}
                <form action="{% url 'order_upload_image' order.id %}" method="POST" enctype="multipart/form-data" class="no-print mt-2">
                    {% csrf_token %}
                    <input type="file" name="resim" accept="image/*" onchange="this.form.submit()" style="display:none" id="imageInput">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('imageInput').click()">📤 Resim Ekle / Değiştir</button>
                </form>
            </div>
        </div>
        {% endif %}

        <hr>

        {% if is_manager %}
<hr>
<h5 class="mt-4">💰 Maliyet & Kâr Bilgileri</h5>
<table class="table table-sm table-bordered bg-white">
    <tr>
        <th>Uygulanan Maliyet</th>
        <td>
            {% if order.maliyet_uygulanan %}
                {{ order.maliyet_uygulanan }} {{ order.maliyet_para_birimi|default:"₺" }}
            {% else %}
                <span class="text-muted">—</span>
            {% endif %}
        </td>
    </tr>
    <tr>
        <th>Satış Fiyatı</th>
        <td>
            {% if order.satis_fiyati %}
                {{ order.satis_fiyati }} {{ order.satis_para_birimi|default:"₺" }}
            {% else %}
                <span class="text-muted">—</span>
            {% endif %}
        </td>
    </tr>
    <tr>
        <th>Efektif Maliyet</th>
        <td>
            {% if order.efektif_maliyet %}
                {{ order.efektif_maliyet }} {{ order.maliyet_para_birimi|default:"₺" }}
            {% else %}
                <span class="text-muted">—</span>
            {% endif %}
        </td>
    </tr>
    <tr>
        <th>Kâr</th>
        <td>
            {% if order.kar %}
                <b>{{ order.kar }} {{ order.maliyet_para_birimi|default:"₺" }}</b>
            {% else %}
                <span class="text-muted">—</span>
            {% endif %}
        </td>
    </tr>
</table>
{% endif %}


        <div class="mt-4 no-print" id="uretim-paneli">
            {% include "core/_uretim_paneli.html" with order=order events=events %}
        </div>

        <!-- ✅ ÜRETİM ADET TAKİBİ -->
        <hr class="mt-4">
        <h5 class="mt-3">📊 Üretim Adet Kaydı</h5>
        <div class="d-flex gap-4 align-items-center no-print">
            <div>
                <input type="checkbox" id="adet_kesim" onchange="adetKaydet(this, 'adet_kesim')">
                <label for="adet_kesim">Kesim Tamamlandı</label>
            </div>

            <div>
                <input type="checkbox" id="adet_dikim" onchange="adetKaydet(this, 'adet_dikim')">
                <label for="adet_dikim">Dikim Tamamlandı</label>
            </div>

            <div>
                <input type="checkbox" id="adet_susleme" onchange="adetKaydet(this, 'adet_susleme')">
                <label for="adet_susleme">Süsleme Tamamlandı</label>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function adetKaydet(checkbox, stage) {
    if (!checkbox.checked) return;
    htmx.ajax('GET', `{% url 'update_stage' order.id %}`, {
        target: '#uretim-paneli',
        swap: 'none',
        values: { 
            stage: stage, 
            value: 'done', 
            is_production_count: '1'
        }
    });
}
</script>

</body>
</html>

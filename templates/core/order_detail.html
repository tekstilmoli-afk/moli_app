{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>SipariÅŸ DetayÄ±</title>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <style>
.label { font-weight: 600; }
.print-btn { float: right; }

.stage-buttons form {
    display: inline-block;
    margin-right: 5px;
    margin-bottom: 5px;
}

/* ğŸ’» Ekran gÃ¶rÃ¼nÃ¼mÃ¼ iÃ§in QR bloÄŸu */
.qr-print-block {
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 14px;
    line-height: 1.3;
}

.qr-print-block img,
.qr-img {
    max-height: 140px;
    width: auto;
}

.qr-print-block .qr-text {
    font-size: 14px;
    line-height: 1.3;
}

/* âœ… YAZDIRMA MODU */
@media print {

    html, body {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: auto !important;
        /* zoom: 0.75;  <-- KÃœÃ‡ÃœLTÃœYORDU, SÄ°LDÄ°K */
    }

    .container, .card {
        max-width: 100% !important;
        width: 100% !important;
        box-shadow: none !important;
        border: none !important;
        margin: 0 !important;
        padding: 5mm !important;
    }

    .no-print,
    .btn-warning,
    .extra-images-section,
    .extra-images-section + form {
        display: none !important;
    }

    /* ğŸ” QR ve yazÄ±larÄ±nÄ± bÃ¼yÃ¼k bas */
    .qr-print-block {
        display: flex !important;
        align-items: center !important;
        gap: 20px !important;
        font-size: 18pt !important;
        line-height: 1.4 !important;
    }

    .qr-print-block img,
    .qr-img {
        max-height: 260px !important;
        width: auto !important;
    }

    .qr-print-block .qr-text {
        font-size: 18pt !important;
        line-height: 1.4 !important;
        font-weight: 600 !important;
    }

    /* Ä°Ã§indeki tÃ¼m satÄ±rlar aynÄ± bÃ¼yÃ¼klÃ¼kte olsun (aÃ§Ä±klama dahil) */
    .qr-print-block .qr-text div {
        font-size: inherit !important;
        line-height: inherit !important;
    }
}

/* ğŸ¯ GÃ¶rsel bÃ¶lÃ¼mÃ¼nÃ¼ Ã¶ne al ve tÄ±klanabilir hale getir */
.extra-images-section {
    position: relative;
    z-index: 999 !important;
}

.extra-images-section a {
    display: inline-block;
    position: relative;
    z-index: 1000 !important;
    pointer-events: auto !important;
    cursor: pointer !important;
}

.extra-images-section img {
    position: relative;
    z-index: 1001 !important;
    pointer-events: auto !important;
    cursor: pointer !important;
    border-radius: 8px;
    transition: transform 0.2s ease;
}

.extra-images-section img:hover {
    transform: scale(1.03);
    filter: brightness(1.05);
}

.extra-images-section * {
    pointer-events: auto !important;
}

.extra-images-section form {
    position: absolute !important;
    top: 2px !important;
    right: 2px !important;
    z-index: 2000 !important;
}

.extra-images-section form button {
    opacity: 1 !important;
    visibility: visible !important;
    display: inline-block !important;
}
</style>

</head>

<body class="bg-light py-5">

    
{% if user.is_authenticated %}
<div class="container mb-3 no-print">
    <div class="d-flex justify-content-end">
        <span class="me-2">ğŸ‘¤ {{ user.username }}</span>
        <a href="{% url 'logout' %}" class="btn btn-sm btn-danger">Ã‡Ä±kÄ±ÅŸ Yap</a>
    </div>
</div>
{% endif %}

<div class="container">
    <div class="card shadow-lg mx-auto p-4" style="max-width: 750px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="{{ back_url }}" class="btn btn-outline-secondary btn-sm no-print">
    â¬… Geri
</a>



            <h2 class="mb-0">ğŸ“¦ SipariÅŸ DetayÄ±</h2>

            {% if is_manager %}
                <a href="{% url 'order_edit' order.id %}" class="btn btn-warning btn-sm">âœï¸ DÃ¼zenle</a>
                <button onclick="window.print()" class="btn btn-outline-primary no-print print-btn">ğŸ–¨ï¸ YazdÄ±r</button>
            {% endif %}
        </div>

        <hr>

        <!-- ğŸ“ Temel Bilgiler -->
        <div class="row mb-3">
            <div class="col-md-6"><span class="label">SipariÅŸ No:</span> {{ order.siparis_numarasi }}</div>
            <div class="col-md-6"><span class="label">SipariÅŸ Tipi:</span> {{ order.siparis_tipi }}</div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
  <span class="label">MÃ¼ÅŸteri:</span>
  {% if order.musteri %}
    {{ order.musteri }}
  {% elif order.siparis_tipi == 'STOK' %}
    <em class="text-secondary">StoÄŸa Ãœretim</em>
  {% else %}
    <span class="text-muted">â€”</span>
  {% endif %}
</div>

            <div class="col-md-6"><span class="label">ÃœrÃ¼n Kodu:</span> {{ order.urun_kodu }}</div>
        </div>

        <div class="row mb-3">
            <div class="col-md-12">
                <span class="label">MÃ¼ÅŸteri SipariÅŸ ReferansÄ±:</span>
                {{ order.musteri_referans|default:"â€”" }}
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6"><span class="label">Renk:</span> {{ order.renk }}</div>
            <div class="col-md-6"><span class="label">Beden:</span> {{ order.beden }}</div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6"><span class="label">Adet:</span> {{ order.adet }}</div>
            <div class="col-md-6"><span class="label">SipariÅŸ Tarihi:</span> {{ order.siparis_tarihi|date:"d.m.Y" }}</div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6"><span class="label">Teslim Tarihi:</span> {{ order.teslim_tarihi|date:"d.m.Y" }}</div>
            <div class="col-md-6"><span class="label">AÃ§Ä±klama:</span> {{ order.aciklama }}</div>
        </div>

        
        <h5 class="fw-bold mt-4">ğŸ“¸ Ek SipariÅŸ GÃ¶rselleri</h5>

<div class="d-flex flex-wrap justify-content-center mb-3 extra-images-section">
    {% for img in order.extra_images.all %}
    <div class="position-relative d-inline-block m-2">
        {% if img.image_url %}
            <!-- ğŸ” TÄ±klanabilir gÃ¶rsel -->
            <img src="{{ img.image_url }}" 
                 alt="Ek GÃ¶rsel"
                 class="img-thumbnail shadow-sm preview-img"
                 style="max-height:180px; border-radius:8px; cursor: zoom-in;">
        {% else %}
            <div class="text-center border rounded p-2 bg-light text-muted" style="width:180px; height:120px;">
                âš ï¸ GÃ¶rsel baÄŸlantÄ±sÄ± yok
            </div>
        {% endif %}

        {% if is_manager %}
        <form action="{% url 'delete_order_image' img.id %}" method="POST"
              class="position-absolute top-0 end-0 m-1 no-print"
              onsubmit="return confirm('Bu gÃ¶rseli silmek istediÄŸine emin misin?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger py-0 px-1"
                    style="font-size: 0.7rem; line-height: 1; opacity: 0.8;">
                âœ•
            </button>
        </form>
        {% endif %}
    </div>
    {% empty %}
    <p class="text-muted">HenÃ¼z ek gÃ¶rsel yok.</p>
    {% endfor %}
</div>

{% if is_manager %}
<form 
  action="{% url 'order_add_image' order.pk %}" 
  method="POST" 
  enctype="multipart/form-data" 
  class="no-print mt-3">
    {% csrf_token %}
    <input type="file" name="images" accept="image/*" multiple required>
    <button type="submit" class="btn btn-outline-secondary btn-sm">
        ğŸ“¤ Ã‡oklu GÃ¶rsel YÃ¼kle
    </button>
</form>
{% endif %}

<!-- ğŸ”´ SÄ°PARÄ°Å DÃœZENLEME GEÃ‡MÄ°ÅÄ° -->
<div class="card border-danger mt-4" style="max-width: 650px; margin: 0 auto;">
    <div class="card-header bg-danger text-white fw-bold">
        âš ï¸ SipariÅŸ DÃ¼zenleme KayÄ±tlarÄ±
    </div>
    <div class="card-body">

        {% if update_events %}
            <ul class="list-group">
                {% for ev in update_events %}
                    <li class="list-group-item">
                        <strong>{{ ev.stage|title }}</strong> alanÄ± deÄŸiÅŸti:

                        <br>
                        <small class="text-muted">Ã–nce:</small>
                        <span class="text-decoration-line-through text-muted">{{ ev.old_value|default:"â€”" }}</span>

                        <br>
                        <small class="text-muted">Sonra:</small>
                        <span class="fw-bold text-danger">{{ ev.new_value }}</span>

                        <br>
                        <small class="text-muted">
                            {{ ev.timestamp|date:"d.m.Y H:i" }} â€” {{ ev.user }}
                        </small>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-muted fst-italic">
                Bu sipariÅŸte henÃ¼z dÃ¼zenleme yapÄ±lmamÄ±ÅŸ.
            </div>
        {% endif %}

    </div>
</div>



<!-- ğŸ” GeliÅŸmiÅŸ GÃ¶rsel Ã–nizleme -->
<style>
#lightboxOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
#lightboxOverlay img {
  display: block;
  max-width: none;
  max-height: none;
  width: 60vw;              /* ğŸ”¹ GÃ¶rsel ekranÄ±n %60â€™Ä± kadar */
  height: auto;
  border-radius: 10px;
  box-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
  transition: transform 0.25s ease-in-out;
  transform: scale(1.05);   /* ğŸ”¹ KÃ¼Ã§Ã¼k ve doÄŸal baÅŸlangÄ±Ã§ */
}

#lightboxOverlay img:hover {
  transform: scale(1.15);   /* ğŸ”¹ Hafif hover bÃ¼yÃ¼mesi */
}

/* ğŸ“± Mobil iÃ§in optimize */
@media (max-width: 768px) {
  #lightboxOverlay img {
    width: 90vw;            /* ğŸ”¹ Mobilde biraz daha bÃ¼yÃ¼k */
    transform: none;
  }
}








#lightboxPrev, #lightboxNext {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 2rem;
  color: white;
  background: rgba(0,0,0,0.4);
  border: none;
  padding: 8px 14px;
  border-radius: 50%;
  cursor: pointer;
  user-select: none;
}
#lightboxPrev:hover, #lightboxNext:hover { background: rgba(255,255,255,0.3); }
#lightboxPrev { left: 30px; }
#lightboxNext { right: 30px; }
@media print { #lightboxOverlay { display: none !important; } }
</style>

<div id="lightboxOverlay">
  <button id="lightboxPrev">âŸ¨</button>
  <img id="lightboxImage" src="">
  <button id="lightboxNext">âŸ©</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const imgs = Array.from(document.querySelectorAll('.preview-img'));
  const overlay = document.getElementById('lightboxOverlay');
  const overlayImg = document.getElementById('lightboxImage');
  const prevBtn = document.getElementById('lightboxPrev');
  const nextBtn = document.getElementById('lightboxNext');
  let currentIndex = -1;

  function showImage(index) {
    if (index < 0 || index >= imgs.length) return;
    overlayImg.src = imgs[index].src;
    overlay.style.display = 'flex';
    currentIndex = index;
  }

  imgs.forEach((img, i) => {
    img.addEventListener('click', () => showImage(i));
  });

  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.style.display = 'none';
  });

  document.addEventListener('keydown', e => {
    if (overlay.style.display === 'flex') {
      if (e.key === 'Escape') overlay.style.display = 'none';
      else if (e.key === 'ArrowRight') showImage((currentIndex + 1) % imgs.length);
      else if (e.key === 'ArrowLeft') showImage((currentIndex - 1 + imgs.length) % imgs.length);
    }
  });

  prevBtn.addEventListener('click', () => showImage((currentIndex - 1 + imgs.length) % imgs.length));
  nextBtn.addEventListener('click', () => showImage((currentIndex + 1) % imgs.length));
});
</script>



        <!-- ğŸ’° Maliyet & KÃ¢r Bilgileri -->
        {% if is_manager %}
        <div class="cost-section no-print">
            <hr>
            <h5 class="mt-4">ğŸ’° Maliyet & KÃ¢r Bilgileri</h5>
            <table class="table table-sm table-bordered bg-white">
                <tr>
                    <th>SatÄ±ÅŸ FiyatÄ±</th>
                    <td>
                        {% if order.satis_fiyati %}
                            {{ order.satis_fiyati|floatformat:2 }} {{ order.para_birimi|default:"â‚º" }}
                        {% else %}
                            <span class="text-muted">â€”</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Etkin Maliyet</th>
                    <td>
                        {% if order.efektif_maliyet %}
                            {{ order.efektif_maliyet|floatformat:2 }} {{ order.maliyet_para_birimi|default:"â‚º" }}
                        {% else %}
                            <span class="text-muted">â€”</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Ekstra Maliyet</th>
                    <td>
                        {% if order.ekstra_maliyet %}
                            {{ order.ekstra_maliyet|floatformat:2 }} {{ order.maliyet_para_birimi|default:"â‚º" }}
                        {% else %}
                            0,00 {{ order.maliyet_para_birimi|default:"â‚º" }}
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Toplam Maliyet</th>
                    <td>{{ order.toplam_maliyet|floatformat:2 }} {{ order.maliyet_para_birimi|default:"â‚º" }}</td>
                </tr>
                <tr>
                    <th><b>KÃ¢r</b></th>
                    <td>
                        {% if order.kar_backend %}
                            <b>{{ order.kar_backend|floatformat:2 }} {{ order.para_birimi|default:"â‚º" }}</b>
                        {% else %}
                            <span class="text-muted">â€”</span>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
        {% endif %}

        


        <!-- ğŸ§µ Ãœretim Paneli -->
        <div class="mt-4 no-print" id="uretim-paneli">
            {% include "core/_uretim_paneli.html" with order=order events=events %}
        </div>

        <hr class="mt-4">
        <h5 class="mt-3">ğŸ“Š Ãœretim Adet KaydÄ±</h5>
        <div class="d-flex gap-4 align-items-center no-print">
            <div>
                <input type="checkbox" id="adet_kesim" onchange="adetKaydet(this, 'adet_kesim')">
                <label for="adet_kesim">Kesim TamamlandÄ±</label>
            </div>
            <div>
                <input type="checkbox" id="adet_dikim" onchange="adetKaydet(this, 'adet_dikim')">
                <label for="adet_dikim">Dikim TamamlandÄ±</label>
            </div>
            <div>
                <input type="checkbox" id="adet_susleme" onchange="adetKaydet(this, 'adet_susleme')">
                <label for="adet_susleme">SÃ¼sleme TamamlandÄ±</label>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ–¨ï¸ GÃ¶rsel YazdÄ±r Butonu (tam buraya ekle) -->
<button id="printImageBtn" class="btn btn-light btn-sm no-print" style="
  position: fixed;
  bottom: 30px;
  right: 50%;
  transform: translateX(50%);
  z-index: 99999;
  box-shadow: 0 3px 10px rgba(0,0,0,0.3);
  border-radius: 6px;
  font-weight: 500;
  display: none;
">
  ğŸ–¨ï¸ YazdÄ±r
</button>

<!-- ğŸ”½ script'ler bundan sonra geliyor -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
function adetKaydet(checkbox, stage) {
    if (!checkbox.checked) return;
    htmx.ajax('GET', `{% url 'update_stage' order.id %}`, {
        target: '#uretim-paneli',
        swap: 'outerHTML',
        values: { 
            stage: stage, 
            value: 'done', 
            is_production_count: '1'
        }
    });
}


// ğŸ–¨ï¸ YazdÄ±rma script'i buraya:
document.addEventListener('click', function(e) {
  const overlay = document.getElementById('lightboxOverlay');
  const printBtn = document.getElementById('printImageBtn');

  if (overlay && overlay.style.display === 'flex') {
    printBtn.style.display = 'block';
  } else {
    printBtn.style.display = 'none';
  }

  if (e.target === overlay) {
    printBtn.style.display = 'none';
  }
});

document.getElementById('printImageBtn').addEventListener('click', function() {
  const img = document.querySelector('#lightboxOverlay img');
  if (!img) return;

  const w = window.open('', '_blank');
  w.document.write(`
    <html>
      <head><title>GÃ¶rsel YazdÄ±r</title></head>
      <body style="margin:0; display:flex; justify-content:center; align-items:center; height:100vh;">
        <img src="${img.src}" style="max-width:100%; max-height:100%;">
        <script>window.print();<\/script>
      </body>
    </html>
  `);
  w.document.close();
});
</script>

<script>
// CSRF Token Al
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Ãœretim aÅŸamalarÄ±nÄ± gÃ¼ncelle
function updateStage(orderId, stage, value, isProductionCount = false) {

    // HTMX AJAX Ã§aÄŸrÄ±sÄ±
    htmx.ajax('POST', `/order/${orderId}/update_stage/`, {
        target: '#uretim-paneli',
        swap: 'outerHTML',
        values: {
            stage: stage,
            value: value,
            is_production_count: isProductionCount
        }
    });
}
</script>


</body>
</html>
